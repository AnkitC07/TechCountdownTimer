{"version":3,"file":"extension.js","sourceRoot":"","sources":["../../../../src/cli/services/dev/extension.ts"],"names":[],"mappings":"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","sourcesContent":["import {getCartPathFromExtensions} from './extension/utilities.js'\nimport {setupWebsocketConnection} from './extension/websocket.js'\nimport {setupBundlerAndFileWatcher} from './extension/bundler.js'\nimport {setupHTTPServer} from './extension/server.js'\nimport {ExtensionsPayloadStore, getExtensionsPayloadStoreRawPayload} from './extension/payload/store.js'\nimport {AppInterface} from '../../models/app/app.js'\nimport {UIExtension} from '../../models/app/extensions.js'\nimport {extensionConfig} from '../../utilities/extensions/configuration.js'\nimport {runGoExtensionsCLI} from '../../utilities/extensions/cli.js'\nimport {output, abort, yaml, environment} from '@shopify/cli-kit'\nimport {Writable} from 'node:stream'\n\nexport interface ExtensionDevOptions {\n  /**\n   * Standard output stream to send the output through.\n   */\n  stdout: Writable\n  /**\n   * Standard error stream to send the error output through.\n   */\n  stderr: Writable\n\n  /**\n   * Signal to abort the build process.\n   */\n  signal: abort.Signal\n\n  /**\n   * Overrides the default build directory.\n   */\n  buildDirectory?: string\n\n  /**\n   * The extension to be built.\n   */\n  extensions: UIExtension[]\n\n  /**\n   * The app that contains the extension.\n   */\n  app: AppInterface\n\n  /**\n   * The app identifier\n   */\n  apiKey: string\n\n  /**\n   * URL where the extension is locally served from. It's usually the tunnel URL\n   */\n  url: string\n\n  /**\n   * The port where the extension is hosted.\n   * It's usually the tunnel port\n   */\n  port: number\n\n  /**\n   * The development store where the extension wants to be previewed\n   */\n  storeFqdn: string\n\n  /**\n   * List of granted approval scopes belonging to the parent app\n   */\n  grantedScopes: string[]\n\n  /**\n   * Product variant ID, used for checkout_ui_extensions\n   * If that extension is present, this is mandatory\n   */\n  checkoutCartUrl?: string\n\n  /**\n   * Subscription product URL, used for subscription_ui_extensions\n   * If not provided the first product in the store will be used\n   */\n  subscriptionProductUrl?: string\n}\n\nexport async function devUIExtensions(options: ExtensionDevOptions): Promise<void> {\n  if (await environment.local.useGoBinary()) {\n    await devUIExtensionsWithGo(options)\n  } else {\n    await devUIExtensionsWithNode(options)\n  }\n}\n\nasync function devUIExtensionsWithGo(options: ExtensionDevOptions): Promise<void> {\n  const config = await extensionConfig({includeResourceURL: true, ...options})\n  output.debug(output.content`Dev'ing extension with configuration:\n${output.token.json(config)}\n`)\n  const input = yaml.encode(config)\n  await runGoExtensionsCLI(['serve', '-'], {\n    cwd: options.app.directory,\n    signal: options.signal,\n    stdout: options.stdout,\n    stderr: options.stderr,\n    input,\n  })\n}\n\nasync function devUIExtensionsWithNode(options: ExtensionDevOptions): Promise<void> {\n  const devOptions: ExtensionDevOptions = {\n    ...options,\n    checkoutCartUrl: await getCartPathFromExtensions(options.extensions, options.storeFqdn, options.checkoutCartUrl),\n  }\n\n  const payloadStoreOptions = {\n    ...devOptions,\n    websocketURL: getWebSocketUrl(options.url),\n  }\n  const payloadStoreRawPayload = await getExtensionsPayloadStoreRawPayload(payloadStoreOptions)\n  const payloadStore = new ExtensionsPayloadStore(payloadStoreRawPayload, payloadStoreOptions)\n\n  output.debug(`Setting up the UI extensions HTTP server...`)\n  const httpServer = setupHTTPServer({devOptions, payloadStore})\n\n  output.debug(`Setting up the UI extensions Websocket server...`)\n  const websocketConnection = setupWebsocketConnection({\n    httpServer,\n    payloadStore,\n  })\n  output.debug(`Setting up the UI extensions bundler and file watching...`)\n  const fileWatcher = await setupBundlerAndFileWatcher({devOptions, payloadStore})\n\n  options.signal.addEventListener('abort', () => {\n    fileWatcher.close()\n    websocketConnection.close()\n    httpServer.close()\n  })\n}\n\nfunction getWebSocketUrl(url: ExtensionDevOptions['url']) {\n  const websocketURL = new URL('/extensions', url)\n  websocketURL.protocol = 'wss:'\n\n  return websocketURL.toString()\n}\n"]}